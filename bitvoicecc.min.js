async function processIncomingEvent(e){let t={salutation:"Mr.",stage:"Prospecting",maxResults:1};if(!window.Espo||!window.Espo.Ajax){console.error("BitvoiceCC: Espo not initialized");return}let a=e.Data?.phoneNumber;if(!a){console.error("BitvoiceCC: Missing required phoneNumber");return}let i=formatPhoneNumber(a);if(!i){console.error("BitvoiceCC: Invalid phone number");return}try{let n=await Espo.Ajax.getRequest(`Opportunity?maxSize=1&where[0][attribute]=phoneNumber&where[0][type]=equals&where[0][value]=${encodePhoneNumberForApi(a)}`);if(n.list.length>0){window.location.hash=`#Opportunity/view/${n.list[0].id}`;return}let l=await Espo.Ajax.getRequest(`Contact?maxSize=1&where[0][attribute]=phoneNumber&where[0][type]=equals&where[0][value]=${encodePhoneNumberForApi(a)}`),r=null,s=null;if(l.list.length>0){r=l.list[0].id;let o=await Espo.Ajax.getRequest(`Opportunity?maxSize=1&where[0][attribute]=contactId&where[0][type]=equals&where[0][value]=${r}`);o.list.length>0&&(s=o.list[0].id)}if(s){window.location.hash=`#Opportunity/view/${s}`;return}((e=null)=>{let a=`
            <div class="modal fade" id="enquiryModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                <span class="fas fa-plus"></span>
                                Create Enquiry
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="enquiryForm" class="record">
                                <div class="record-grid">
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <!-- Name Section -->
                                            <div class="cell form-group" data-name="name">
                                                <label class="control-label" data-name="name">
                                                    Name
                                                    <span class="required-sign">*</span>
                                                </label>
                                                <div class="field" data-name="name">
                                                    <div class="row">
                                                        <div class="col-sm-2">
                                                            <select class="form-control main-element" name="salutationName">
                                                                <option value="Mr.">Mr.</option>
                                                                <option value="Mrs.">Mrs.</option>
                                                                <option value="Ms.">Ms.</option>
                                                                <option value="Dr.">Dr.</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-5">
                                                            <input type="text" class="form-control main-element" name="firstName" placeholder="First Name" required maxlength="100">
                                                        </div>
                                                        <div class="col-sm-5">
                                                            <input type="text" class="form-control main-element" name="lastName" placeholder="Last Name" required maxlength="100">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Phone -->
                                            <div class="cell form-group" data-name="phone">
                                                <label class="control-label" data-name="phone">Phone</label>
                                                <div class="field" data-name="phone">
                                                    <input type="tel" class="form-control main-element" name="phoneNumber" value="${i}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveEnquiry">Save</button>
                        </div>
                    </div>
                </div>
            </div>`,n=$(a).appendTo("body");n.modal("show"),$("#saveEnquiry").on("click",async function(){let a=document.getElementById("enquiryForm");if(!a.checkValidity()){a.reportValidity();return}let i=new FormData(a),l={stage:t.stage,salutationName:i.get("salutationName")||t.salutation,...Object.fromEntries(i),name:`${i.get("firstName")} ${i.get("lastName")}`};e?.id&&(l.contactId=e.id);let r=$(this);r.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span> Saving...');try{let s=await Espo.Ajax.postRequest("Opportunity",l);n.modal("hide"),window.location.hash=`#Opportunity/view/${s.id}`}catch(o){console.error("Error creating opportunity:",o),Espo.Ui.error("Error creating opportunity. Please try again.")}finally{r.prop("disabled",!1).text("Save")}}),n.on("hidden.bs.modal",function(){n.remove()}),e&&Object.entries(e).forEach(([e,t])=>{let a=n.find(`[name="${e}"]`);a.length&&a.val(t)})})(r)}catch(d){console.error("BitvoiceCC Error:",d);let c=new URLSearchParams({phoneNumber:a,contactId:contactId||""});window.location.hash=`#Opportunity/create?${c.toString()}`}}function formatPhoneNumber(e){if(!e)return console.error("BitvoiceCC: Missing required phoneNumber"),null;let t=e.replace(/\D/g,"");if(t.length<10)return console.error("BitvoiceCC: Invalid phone number length"),null;if(t.startsWith("00"))return"+"+t.slice(2);if(10===t.length||11===t.length&&t.startsWith("0")){let a=t.startsWith("0")?t.slice(1):t;return"+91"+a}return t.length>10?t.startsWith("+")?t:"+"+t:null}function encodePhoneNumberForApi(e){let t=formatPhoneNumber(e);if(!t)throw Error("Invalid phone number format");return encodeURIComponent(t)}window.BitvoiceCCF={activeCalls:new Map,EVENT_TYPES:{INBOUND_CALL:"INBOUND_CALL",OUTBOUND_CALL:"OUTBOUND_CALL",HANGUP:"HANGUP",AGENT_LOGIN:"AGENT_LOGIN",MISSEDCALL:"MISSEDCALL"},async handleEvent(e){let{Event:t,Data:a}=e;if(!Object.values(this.EVENT_TYPES).includes(t)){console.log(`Unhandled event type: ${t}`);return}try{switch(t){case this.EVENT_TYPES.INBOUND_CALL:await this.handleInboundCall(e);break;case this.EVENT_TYPES.OUTBOUND_CALL:await this.handleOutboundCall(e);break;case this.EVENT_TYPES.HANGUP:await this.handleHangup(e);break;case this.EVENT_TYPES.AGENT_LOGIN:await this.handleAgentLogin(e);break;case this.EVENT_TYPES.MISSEDCALL:await this.handleMissedCall(e)}}catch(i){console.error("Error handling event:",i)}},async handleOutboundCall(e){let{Data:t}=e,a=t.uniqueid;this.activeCalls.set(a,{startTime:new Date,data:t}),await processIncomingEvent(e)},async handleInboundCall(e){let{Data:t}=e,a=t.uniqueid;this.activeCalls.set(a,{startTime:new Date,data:t}),await processIncomingEvent(e)},async handleHangup(e){let{Data:t}=e,a=t.uniqueid;if(this.activeCalls.has(a)){let i=this.activeCalls.get(a),n=new Date-i.startTime;e.Data.duration=n,this.activeCalls.delete(a)}},async handleAgentLogin(e){},async handleMissedCall(e){}},window.BitvoiceCC=function(e){window.BitvoiceCCF.handleEvent(e)},window.BitvoiceCCAPI=window.BitvoiceCC;
